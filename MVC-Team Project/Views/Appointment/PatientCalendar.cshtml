@{
    ViewData["Title"] = "Patient Calendar";
    Layout = "_DoctorDashbordLayout";

}

<div class="container">
    <h2>Book an Appointment</h2>
    <div class="mb-3">
        <label class="form-label">Select Doctor</label>
        <select id="doctorSelect" class="form-select">
            @foreach (var doctor in ViewBag.Doctors)
            {
                <option value="@doctor.Id">@doctor.FullName</option>
            }
        </select>
    </div>
    <div id="calendar"></div>

    <!-- Modal for Booking Appointment -->
    <div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookModalLabel">Book Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookForm" asp-action="Book" asp-controller="Appointment" method="post">
                        <input type="hidden" name="Id" id="appointmentId" />
                        <div class="mb-3">
                            <label class="form-label">Doctor</label>
                            <input type="text" class="form-control" id="doctorName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="text" class="form-control" id="appointmentDate" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Time</label>
                            <input type="text" class="form-control" id="appointmentTime" readonly>
                        </div>
                        <button type="submit" class="btn btn-primary">Book</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>
    @* <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script> *@
    <script src="~/js/popper.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: function(fetchInfo, successCallback) {
                    var doctorId = $('#doctorSelect').val();
                    if (doctorId) {
                        $.get('/Appointment/GetBusyDates?doctorId=' + doctorId, function(data) {
                            var events = data.map(d => ({ title: 'Busy', start: d, allDay: true }));
                            successCallback(events);
                        });
                    }
                },
                datesSet: function() {
                    loadSlots();
                },
                selectable: true,
                select: function(info) {
                    var doctorId = $('#doctorSelect').val();
                    if (doctorId) {
                        $.get('/Appointment/GetSlots?doctorId=' + doctorId + '&date=' + info.startStr, function(slots) {
                            slots.forEach(slot => {
                                if (slot.Status === 'Available') {
                                    $('#appointmentId').val(slot.Id);
                                    $('#doctorName').val('@ViewBag.Doctors.First().FullName'); // Dynamic later
                                    $('#appointmentDate').val(info.startStr);
                                    $('#appointmentTime').val(slot.start + ' - ' + slot.end);
                                    $('#bookModal').modal('show');
                                }
                            });
                        });
                    }
                }
            });
            calendar.render();

            $('#doctorSelect').change(function() {
                calendar.refetchEvents();
            });

            function loadSlots() {
                var doctorId = $('#doctorSelect').val();
                if (doctorId) {
                    $.get('/Appointment/GetSlots?doctorId=' + doctorId + '&date=' + calendar.getDate().toISOString().split('T')[0], function(slots) {
                        var events = slots.map(slot => ({
                            title: slot.Status === 'Available' ? 'Available' : 'Booked',
                            start: calendar.getDate().toISOString().split('T')[0] + 'T' + slot.start,
                            end: calendar.getDate().toISOString().split('T')[0] + 'T' + slot.end,
                            color: slot.Status === 'Available' ? 'green' : 'red'
                        }));
                        calendar.addEventSource(events);
                    });
                }
            }
        });
    </script>
}